var Uz="w",Vz="b",Gz="p",Lz="n",Dz="b",Yz="r",jz="q",Kz="k",_z="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1";class O{color;from;to;piece;captured;promotion;flags;san;lan;before;after;constructor(z,J){let{color:Q,piece:Z,from:X,to:U,flags:$,captured:V,promotion:j}=J,_=A(X),N=A(U);this.color=Q,this.piece=Z,this.from=_,this.to=N,this.san=z._moveToSan(J,z._moves({legal:!0})),this.lan=_+N,this.before=z.fen(),z._makeMove(J),this.after=z.fen(),z._undoMove(),this.flags="";for(let G in Y)if(Y[G]&$)this.flags+=I[G];if(V)this.captured=V;if(j)this.promotion=j,this.lan+=j}isCapture(){return this.flags.indexOf(I.CAPTURE)>-1}isPromotion(){return this.flags.indexOf(I.PROMOTION)>-1}isEnPassant(){return this.flags.indexOf(I.EP_CAPTURE)>-1}isKingsideCastle(){return this.flags.indexOf(I.KSIDE_CASTLE)>-1}isQueensideCastle(){return this.flags.indexOf(I.QSIDE_CASTLE)>-1}isBigPawn(){return this.flags.indexOf(I.BIG_PAWN)>-1}}var R=-1,I={NORMAL:"n",CAPTURE:"c",BIG_PAWN:"b",EP_CAPTURE:"e",PROMOTION:"p",KSIDE_CASTLE:"k",QSIDE_CASTLE:"q"},Hz=["a8","b8","c8","d8","e8","f8","g8","h8","a7","b7","c7","d7","e7","f7","g7","h7","a6","b6","c6","d6","e6","f6","g6","h6","a5","b5","c5","d5","e5","f5","g5","h5","a4","b4","c4","d4","e4","f4","g4","h4","a3","b3","c3","d3","e3","f3","g3","h3","a2","b2","c2","d2","e2","f2","g2","h2","a1","b1","c1","d1","e1","f1","g1","h1"],Y={NORMAL:1,CAPTURE:2,BIG_PAWN:4,EP_CAPTURE:8,PROMOTION:16,KSIDE_CASTLE:32,QSIDE_CASTLE:64},d={Event:"?",Site:"?",Date:"????.??.??",Round:"?",White:"?",Black:"?",Result:"*"},n={WhiteTitle:null,BlackTitle:null,WhiteElo:null,BlackElo:null,WhiteUSCF:null,BlackUSCF:null,WhiteNA:null,BlackNA:null,WhiteType:null,BlackType:null,EventDate:null,EventSponsor:null,Section:null,Stage:null,Board:null,Opening:null,Variation:null,SubVariation:null,ECO:null,NIC:null,Time:null,UTCTime:null,UTCDate:null,TimeControl:null,SetUp:null,FEN:null,Termination:null,Annotator:null,Mode:null,PlyCount:null},a={...d,...n},D={a8:0,b8:1,c8:2,d8:3,e8:4,f8:5,g8:6,h8:7,a7:16,b7:17,c7:18,d7:19,e7:20,f7:21,g7:22,h7:23,a6:32,b6:33,c6:34,d6:35,e6:36,f6:37,g6:38,h6:39,a5:48,b5:49,c5:50,d5:51,e5:52,f5:53,g5:54,h5:55,a4:64,b4:65,c4:66,d4:67,e4:68,f4:69,g4:70,h4:71,a3:80,b3:81,c3:82,d3:83,e3:84,f3:85,g3:86,h3:87,a2:96,b2:97,c2:98,d2:99,e2:100,f2:101,g2:102,h2:103,a1:112,b1:113,c1:114,d1:115,e1:116,f1:117,g1:118,h1:119},f={b:[16,32,17,15],w:[-16,-32,-17,-15]},u={n:[-18,-33,-31,-14,18,33,31,14],b:[-17,-15,17,15],r:[-16,1,16,-1],q:[-17,-16,-15,1,17,16,15,-1],k:[-17,-16,-15,1,17,16,15,-1]},t=[20,0,0,0,0,0,0,24,0,0,0,0,0,0,20,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,24,24,24,24,24,24,56,0,56,24,24,24,24,24,24,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,20,0,0,0,0,0,0,24,0,0,0,0,0,0,20],m=[17,0,0,0,0,0,0,16,0,0,0,0,0,0,15,0,0,17,0,0,0,0,0,16,0,0,0,0,0,15,0,0,0,0,17,0,0,0,0,16,0,0,0,0,15,0,0,0,0,0,0,17,0,0,0,16,0,0,0,15,0,0,0,0,0,0,0,0,17,0,0,16,0,0,15,0,0,0,0,0,0,0,0,0,0,17,0,16,0,15,0,0,0,0,0,0,0,0,0,0,0,0,17,16,15,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,-15,-16,-17,0,0,0,0,0,0,0,0,0,0,0,0,-15,0,-16,0,-17,0,0,0,0,0,0,0,0,0,0,-15,0,0,-16,0,0,-17,0,0,0,0,0,0,0,0,-15,0,0,0,-16,0,0,0,-17,0,0,0,0,0,0,-15,0,0,0,0,-16,0,0,0,0,-17,0,0,0,0,-15,0,0,0,0,0,-16,0,0,0,0,0,-17,0,0,-15,0,0,0,0,0,0,-16,0,0,0,0,0,0,-17],i={p:1,n:2,b:4,r:8,q:16,k:32},r="pnbrqkPNBRQK",l=["n","b","r","q"],s=7,o=6,e=1,zz=0,x={["k"]:Y.KSIDE_CASTLE,["q"]:Y.QSIDE_CASTLE},F={w:[{square:D.a1,flag:Y.QSIDE_CASTLE},{square:D.h1,flag:Y.KSIDE_CASTLE}],b:[{square:D.a8,flag:Y.QSIDE_CASTLE},{square:D.h8,flag:Y.KSIDE_CASTLE}]},Jz={b:e,w:o},Qz=["1-0","0-1","1/2-1/2","*"];function b(z){return z>>4}function q(z){return z&15}function v(z){return"0123456789".indexOf(z)!==-1}function A(z){let J=q(z),Q=b(z);return"abcdefgh".substring(J,J+1)+"87654321".substring(Q,Q+1)}function y(z){return z==="w"?"b":"w"}function Xz(z){let J=z.split(/\s+/);if(J.length!==6)return{ok:!1,error:"Invalid FEN: must contain six space-delimited fields"};let Q=parseInt(J[5],10);if(isNaN(Q)||Q<=0)return{ok:!1,error:"Invalid FEN: move number must be a positive integer"};let Z=parseInt(J[4],10);if(isNaN(Z)||Z<0)return{ok:!1,error:"Invalid FEN: half move counter number must be a non-negative integer"};if(!/^(-|[abcdefgh][36])$/.test(J[3]))return{ok:!1,error:"Invalid FEN: en-passant square is invalid"};if(/[^kKqQ-]/.test(J[2]))return{ok:!1,error:"Invalid FEN: castling availability is invalid"};if(!/^(w|b)$/.test(J[1]))return{ok:!1,error:"Invalid FEN: side-to-move is invalid"};let X=J[0].split("/");if(X.length!==8)return{ok:!1,error:"Invalid FEN: piece data does not contain 8 '/'-delimited rows"};for(let $=0;$<X.length;$++){let V=0,j=!1;for(let _=0;_<X[$].length;_++)if(v(X[$][_])){if(j)return{ok:!1,error:"Invalid FEN: piece data is invalid (consecutive number)"};V+=parseInt(X[$][_],10),j=!0}else{if(!/^[prnbqkPRNBQK]$/.test(X[$][_]))return{ok:!1,error:"Invalid FEN: piece data is invalid (invalid piece)"};V+=1,j=!1}if(V!==8)return{ok:!1,error:"Invalid FEN: piece data is invalid (too many squares in rank)"}}if(J[3][1]=="3"&&J[1]=="w"||J[3][1]=="6"&&J[1]=="b")return{ok:!1,error:"Invalid FEN: illegal en-passant square"};let U=[{color:"white",regex:/K/g},{color:"black",regex:/k/g}];for(let{color:$,regex:V}of U){if(!V.test(J[0]))return{ok:!1,error:`Invalid FEN: missing ${$} king`};if((J[0].match(V)||[]).length>1)return{ok:!1,error:`Invalid FEN: too many ${$} kings`}}if(Array.from(X[0]+X[7]).some(($)=>$.toUpperCase()==="P"))return{ok:!1,error:"Invalid FEN: some pawns are on the edge rows"};return{ok:!0}}function Zz(z,J){let{from:Q,to:Z,piece:X}=z,U=0,$=0,V=0;for(let j=0,_=J.length;j<_;j++){let N=J[j].from,G=J[j].to,L=J[j].piece;if(X===L&&Q!==N&&Z===G){if(U++,b(Q)===b(N))$++;if(q(Q)===q(N))V++}}if(U>0)if($>0&&V>0)return A(Q);else if(V>0)return A(Q).charAt(1);else return A(Q).charAt(0);return""}function w(z,J,Q,Z,X,U=void 0,$=Y.NORMAL){let V=b(Z);if(X==="p"&&(V===s||V===zz))for(let j=0;j<l.length;j++){let _=l[j];z.push({color:J,from:Q,to:Z,piece:X,captured:U,promotion:_,flags:$|Y.PROMOTION})}else z.push({color:J,from:Q,to:Z,piece:X,captured:U,flags:$})}function c(z){let J=z.charAt(0);if(J>="a"&&J<="h"){if(z.match(/[a-h]\d.*[a-h]\d/))return;return"p"}if(J=J.toLowerCase(),J==="o")return"k";return J}function h(z){return z.replace(/=/,"").replace(/[+#]?[?!]*$/,"")}function S(z){return z.split(" ").slice(0,4).join(" ")}class $z{_board=new Array(128);_turn="w";_header={};_kings={w:R,b:R};_epSquare=-1;_halfMoves=0;_moveNumber=0;_history=[];_comments={};_castling={w:0,b:0};_positionCount={};constructor(z="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",{skipValidation:J=!1}={}){this.load(z,{skipValidation:J})}clear({preserveHeaders:z=!1}={}){this._board=new Array(128),this._kings={w:R,b:R},this._turn="w",this._castling={w:0,b:0},this._epSquare=R,this._halfMoves=0,this._moveNumber=1,this._history=[],this._comments={},this._header=z?this._header:{...a},this._positionCount={},this._header.SetUp=null,this._header.FEN=null}load(z,{skipValidation:J=!1,preserveHeaders:Q=!1}={}){let Z=z.split(/\s+/);if(Z.length>=2&&Z.length<6){let $=["-","-","0","1"];z=Z.concat($.slice(-(6-Z.length))).join(" ")}if(Z=z.split(/\s+/),!J){let{ok:$,error:V}=Xz(z);if(!$)throw new Error(V)}let X=Z[0],U=0;this.clear({preserveHeaders:Q});for(let $=0;$<X.length;$++){let V=X.charAt($);if(V==="/")U+=8;else if(v(V))U+=parseInt(V,10);else{let j=V<"a"?"w":"b";this._put({type:V.toLowerCase(),color:j},A(U)),U++}}if(this._turn=Z[1],Z[2].indexOf("K")>-1)this._castling.w|=Y.KSIDE_CASTLE;if(Z[2].indexOf("Q")>-1)this._castling.w|=Y.QSIDE_CASTLE;if(Z[2].indexOf("k")>-1)this._castling.b|=Y.KSIDE_CASTLE;if(Z[2].indexOf("q")>-1)this._castling.b|=Y.QSIDE_CASTLE;this._epSquare=Z[3]==="-"?R:D[Z[3]],this._halfMoves=parseInt(Z[4],10),this._moveNumber=parseInt(Z[5],10),this._updateSetup(z),this._incPositionCount(z)}fen(){let z=0,J="";for(let X=D.a8;X<=D.h1;X++){if(this._board[X]){if(z>0)J+=z,z=0;let{color:U,type:$}=this._board[X];J+=U==="w"?$.toUpperCase():$.toLowerCase()}else z++;if(X+1&136){if(z>0)J+=z;if(X!==D.h1)J+="/";z=0,X+=8}}let Q="";if(this._castling.w&Y.KSIDE_CASTLE)Q+="K";if(this._castling.w&Y.QSIDE_CASTLE)Q+="Q";if(this._castling.b&Y.KSIDE_CASTLE)Q+="k";if(this._castling.b&Y.QSIDE_CASTLE)Q+="q";Q=Q||"-";let Z="-";if(this._epSquare!==R){let X=this._epSquare+(this._turn==="w"?16:-16),U=[X+1,X-1];for(let $ of U){if($&136)continue;let V=this._turn;if(this._board[$]?.color===V&&this._board[$]?.type==="p"){this._makeMove({color:V,from:$,to:this._epSquare,piece:"p",captured:"p",flags:Y.EP_CAPTURE});let j=!this._isKingAttacked(V);if(this._undoMove(),j){Z=A(this._epSquare);break}}}}return[J,this._turn,Q,Z,this._halfMoves,this._moveNumber].join(" ")}_updateSetup(z){if(this._history.length>0)return;if(z!=="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1")this._header.SetUp="1",this._header.FEN=z;else this._header.SetUp=null,this._header.FEN=null}reset(){this.load("rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1")}get(z){return this._board[D[z]]}findPiece(z){let J=[];for(let Q=D.a8;Q<=D.h1;Q++){if(Q&136){Q+=7;continue}if(!this._board[Q]||this._board[Q]?.color!==z.color)continue;if(this._board[Q].color===z.color&&this._board[Q].type===z.type)J.push(A(Q))}return J}put({type:z,color:J},Q){if(this._put({type:z,color:J},Q))return this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),!0;return!1}_put({type:z,color:J},Q){if(r.indexOf(z.toLowerCase())===-1)return!1;if(!(Q in D))return!1;let Z=D[Q];if(z=="k"&&!(this._kings[J]==R||this._kings[J]==Z))return!1;let X=this._board[Z];if(X&&X.type==="k")this._kings[X.color]=R;if(this._board[Z]={type:z,color:J},z==="k")this._kings[J]=Z;return!0}remove(z){let J=this.get(z);if(delete this._board[D[z]],J&&J.type==="k")this._kings[J.color]=R;return this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),J}_updateCastlingRights(){let z=this._board[D.e1]?.type==="k"&&this._board[D.e1]?.color==="w",J=this._board[D.e8]?.type==="k"&&this._board[D.e8]?.color==="b";if(!z||this._board[D.a1]?.type!=="r"||this._board[D.a1]?.color!=="w")this._castling.w&=~Y.QSIDE_CASTLE;if(!z||this._board[D.h1]?.type!=="r"||this._board[D.h1]?.color!=="w")this._castling.w&=~Y.KSIDE_CASTLE;if(!J||this._board[D.a8]?.type!=="r"||this._board[D.a8]?.color!=="b")this._castling.b&=~Y.QSIDE_CASTLE;if(!J||this._board[D.h8]?.type!=="r"||this._board[D.h8]?.color!=="b")this._castling.b&=~Y.KSIDE_CASTLE}_updateEnPassantSquare(){if(this._epSquare===R)return;let z=this._epSquare+(this._turn==="w"?-16:16),J=this._epSquare+(this._turn==="w"?16:-16),Q=[J+1,J-1];if(this._board[z]!==null||this._board[this._epSquare]!==null||this._board[J]?.color!==y(this._turn)||this._board[J]?.type!=="p"){this._epSquare=R;return}let Z=(X)=>!(X&136)&&this._board[X]?.color===this._turn&&this._board[X]?.type==="p";if(!Q.some(Z))this._epSquare=R}_attacked(z,J,Q){let Z=[];for(let X=D.a8;X<=D.h1;X++){if(X&136){X+=7;continue}if(this._board[X]===void 0||this._board[X].color!==z)continue;let U=this._board[X],$=X-J;if($===0)continue;let V=$+119;if(t[V]&i[U.type]){if(U.type==="p"){if($>0&&U.color==="w"||$<=0&&U.color==="b")if(!Q)return!0;else Z.push(A(X));continue}if(U.type==="n"||U.type==="k")if(!Q)return!0;else{Z.push(A(X));continue}let j=m[V],_=X+j,N=!1;while(_!==J){if(this._board[_]!=null){N=!0;break}_+=j}if(!N)if(!Q)return!0;else{Z.push(A(X));continue}}}if(Q)return Z;else return!1}attackers(z,J){if(!J)return this._attacked(this._turn,D[z],!0);else return this._attacked(J,D[z],!0)}_isKingAttacked(z){let J=this._kings[z];return J===-1?!1:this._attacked(y(z),J)}isAttacked(z,J){return this._attacked(J,D[z])}isCheck(){return this._isKingAttacked(this._turn)}inCheck(){return this.isCheck()}isCheckmate(){return this.isCheck()&&this._moves().length===0}isStalemate(){return!this.isCheck()&&this._moves().length===0}isInsufficientMaterial(){let z={b:0,n:0,r:0,q:0,k:0,p:0},J=[],Q=0,Z=0;for(let X=D.a8;X<=D.h1;X++){if(Z=(Z+1)%2,X&136){X+=7;continue}let U=this._board[X];if(U){if(z[U.type]=U.type in z?z[U.type]+1:1,U.type==="b")J.push(Z);Q++}}if(Q===2)return!0;else if(Q===3&&(z.b===1||z.n===1))return!0;else if(Q===z.b+2){let X=0,U=J.length;for(let $=0;$<U;$++)X+=J[$];if(X===0||X===U)return!0}return!1}isThreefoldRepetition(){return this._getPositionCount(this.fen())>=3}isDrawByFiftyMoves(){return this._halfMoves>=100}isDraw(){return this.isDrawByFiftyMoves()||this.isStalemate()||this.isInsufficientMaterial()||this.isThreefoldRepetition()}isGameOver(){return this.isCheckmate()||this.isStalemate()||this.isDraw()}moves({verbose:z=!1,square:J=void 0,piece:Q=void 0}={}){let Z=this._moves({square:J,piece:Q});if(z)return Z.map((X)=>new O(this,X));else return Z.map((X)=>this._moveToSan(X,Z))}_moves({legal:z=!0,piece:J=void 0,square:Q=void 0}={}){let Z=Q?Q.toLowerCase():void 0,X=J?.toLowerCase(),U=[],$=this._turn,V=y($),j=D.a8,_=D.h1,N=!1;if(Z)if(!(Z in D))return[];else j=_=D[Z],N=!0;for(let L=j;L<=_;L++){if(L&136){L+=7;continue}if(!this._board[L]||this._board[L].color===V)continue;let{type:W}=this._board[L],H;if(W==="p"){if(X&&X!==W)continue;if(H=L+f[$][0],!this._board[H]){if(w(U,$,L,H,"p"),H=L+f[$][1],Jz[$]===b(L)&&!this._board[H])w(U,$,L,H,"p",void 0,Y.BIG_PAWN)}for(let P=2;P<4;P++){if(H=L+f[$][P],H&136)continue;if(this._board[H]?.color===V)w(U,$,L,H,"p",this._board[H].type,Y.CAPTURE);else if(H===this._epSquare)w(U,$,L,H,"p","p",Y.EP_CAPTURE)}}else{if(X&&X!==W)continue;for(let P=0,E=u[W].length;P<E;P++){let M=u[W][P];H=L;while(!0){if(H+=M,H&136)break;if(!this._board[H])w(U,$,L,H,W);else{if(this._board[H].color===$)break;w(U,$,L,H,W,this._board[H].type,Y.CAPTURE);break}if(W==="n"||W==="k")break}}}}if(X===void 0||X==="k"){if(!N||_===this._kings[$]){if(this._castling[$]&Y.KSIDE_CASTLE){let L=this._kings[$],W=L+2;if(!this._board[L+1]&&!this._board[W]&&!this._attacked(V,this._kings[$])&&!this._attacked(V,L+1)&&!this._attacked(V,W))w(U,$,this._kings[$],W,"k",void 0,Y.KSIDE_CASTLE)}if(this._castling[$]&Y.QSIDE_CASTLE){let L=this._kings[$],W=L-2;if(!this._board[L-1]&&!this._board[L-2]&&!this._board[L-3]&&!this._attacked(V,this._kings[$])&&!this._attacked(V,L-1)&&!this._attacked(V,W))w(U,$,this._kings[$],W,"k",void 0,Y.QSIDE_CASTLE)}}}if(!z||this._kings[$]===-1)return U;let G=[];for(let L=0,W=U.length;L<W;L++){if(this._makeMove(U[L]),!this._isKingAttacked($))G.push(U[L]);this._undoMove()}return G}move(z,{strict:J=!1}={}){let Q=null;if(typeof z==="string")Q=this._moveFromSan(z,J);else if(typeof z==="object"){let X=this._moves();for(let U=0,$=X.length;U<$;U++)if(z.from===A(X[U].from)&&z.to===A(X[U].to)&&(!("promotion"in X[U])||z.promotion===X[U].promotion)){Q=X[U];break}}if(!Q)if(typeof z==="string")throw new Error(`Invalid move: ${z}`);else throw new Error(`Invalid move: ${JSON.stringify(z)}`);let Z=new O(this,Q);return this._makeMove(Q),this._incPositionCount(Z.after),Z}_push(z){this._history.push({move:z,kings:{b:this._kings.b,w:this._kings.w},turn:this._turn,castling:{b:this._castling.b,w:this._castling.w},epSquare:this._epSquare,halfMoves:this._halfMoves,moveNumber:this._moveNumber})}_makeMove(z){let J=this._turn,Q=y(J);if(this._push(z),this._board[z.to]=this._board[z.from],delete this._board[z.from],z.flags&Y.EP_CAPTURE)if(this._turn==="b")delete this._board[z.to-16];else delete this._board[z.to+16];if(z.promotion)this._board[z.to]={type:z.promotion,color:J};if(this._board[z.to].type==="k"){if(this._kings[J]=z.to,z.flags&Y.KSIDE_CASTLE){let Z=z.to-1,X=z.to+1;this._board[Z]=this._board[X],delete this._board[X]}else if(z.flags&Y.QSIDE_CASTLE){let Z=z.to+1,X=z.to-2;this._board[Z]=this._board[X],delete this._board[X]}this._castling[J]=0}if(this._castling[J]){for(let Z=0,X=F[J].length;Z<X;Z++)if(z.from===F[J][Z].square&&this._castling[J]&F[J][Z].flag){this._castling[J]^=F[J][Z].flag;break}}if(this._castling[Q]){for(let Z=0,X=F[Q].length;Z<X;Z++)if(z.to===F[Q][Z].square&&this._castling[Q]&F[Q][Z].flag){this._castling[Q]^=F[Q][Z].flag;break}}if(z.flags&Y.BIG_PAWN)if(J==="b")this._epSquare=z.to-16;else this._epSquare=z.to+16;else this._epSquare=R;if(z.piece==="p")this._halfMoves=0;else if(z.flags&(Y.CAPTURE|Y.EP_CAPTURE))this._halfMoves=0;else this._halfMoves++;if(J==="b")this._moveNumber++;this._turn=Q}undo(){let z=this._undoMove();if(z){let J=new O(this,z);return this._decPositionCount(J.after),J}return null}_undoMove(){let z=this._history.pop();if(z===void 0)return null;let J=z.move;this._kings=z.kings,this._turn=z.turn,this._castling=z.castling,this._epSquare=z.epSquare,this._halfMoves=z.halfMoves,this._moveNumber=z.moveNumber;let Q=this._turn,Z=y(Q);if(this._board[J.from]=this._board[J.to],this._board[J.from].type=J.piece,delete this._board[J.to],J.captured)if(J.flags&Y.EP_CAPTURE){let X;if(Q==="b")X=J.to-16;else X=J.to+16;this._board[X]={type:"p",color:Z}}else this._board[J.to]={type:J.captured,color:Z};if(J.flags&(Y.KSIDE_CASTLE|Y.QSIDE_CASTLE)){let X,U;if(J.flags&Y.KSIDE_CASTLE)X=J.to+1,U=J.to-1;else X=J.to-2,U=J.to+1;this._board[X]=this._board[U],delete this._board[U]}return J}pgn({newline:z=`
`,maxWidth:J=0}={}){let Q=[],Z=!1;for(let G in this._header){if(this._header[G])Q.push(`[${G} "${this._header[G]}"]`+z);Z=!0}if(Z&&this._history.length)Q.push(z);let X=(G)=>{let L=this._comments[this.fen()];if(typeof L!=="undefined"){let W=G.length>0?" ":"";G=`${G}${W}{${L}}`}return G},U=[];while(this._history.length>0)U.push(this._undoMove());let $=[],V="";if(U.length===0)$.push(X(""));while(U.length>0){V=X(V);let G=U.pop();if(!G)break;if(!this._history.length&&G.color==="b"){let L=`${this._moveNumber}. ...`;V=V?`${V} ${L}`:L}else if(G.color==="w"){if(V.length)$.push(V);V=this._moveNumber+"."}V=V+" "+this._moveToSan(G,this._moves({legal:!0})),this._makeMove(G)}if(V.length)$.push(X(V));if($.push(this._header.Result||"*"),J===0)return Q.join("")+$.join(" ");let j=function(){if(Q.length>0&&Q[Q.length-1]===" ")return Q.pop(),!0;return!1},_=function(G,L){for(let W of L.split(" ")){if(!W)continue;if(G+W.length>J){while(j())G--;Q.push(z),G=0}Q.push(W),G+=W.length,Q.push(" "),G++}if(j())G--;return G},N=0;for(let G=0;G<$.length;G++){if(N+$[G].length>J){if($[G].includes("{")){N=_(N,$[G]);continue}}if(N+$[G].length>J&&G!==0){if(Q[Q.length-1]===" ")Q.pop();Q.push(z),N=0}else if(G!==0)Q.push(" "),N++;Q.push($[G]),N+=$[G].length}return Q.join("")}header(...z){for(let J=0;J<z.length;J+=2)if(typeof z[J]==="string"&&typeof z[J+1]==="string")this._header[z[J]]=z[J+1];return this._header}setHeader(z,J){return this._header[z]=J??d[z]??null,this.getHeaders()}removeHeader(z){if(z in this._header)return this._header[z]=d[z]||null,!0;return!1}getHeaders(){let z={};for(let[J,Q]of Object.entries(this._header))if(Q!==null)z[J]=Q;return z}loadPgn(z,{strict:J=!1,newlineChar:Q=`\r?
`}={}){function Z(K){return K.replace(/\\/g,"\\")}function X(K){let C={},B=K.split(new RegExp(Z(Q))),T="",g="";for(let k=0;k<B.length;k++){let p=/^\s*\[\s*([A-Za-z]+)\s*"(.*)"\s*\]\s*$/;if(T=B[k].replace(p,"$1"),g=B[k].replace(p,"$2"),T.trim().length>0)C[T]=g}return C}z=z.trim();let $=new RegExp("^(\\[((?:"+Z(Q)+")|.)*\\])((?:\\s*"+Z(Q)+"){2}|(?:\\s*"+Z(Q)+")*$)").exec(z),V=$?$.length>=2?$[1]:"":"";this.reset();let j=X(V),_="";for(let K in j){if(K.toLowerCase()==="fen")_=j[K];this.header(K,j[K])}if(!J){if(_)this.load(_,{preserveHeaders:!0})}else if(j.SetUp==="1"){if(!("FEN"in j))throw new Error("Invalid PGN: FEN tag must be supplied with SetUp tag");this.load(j.FEN,{preserveHeaders:!0})}function N(K){return Array.from(K).map(function(C){return C.charCodeAt(0)<128?C.charCodeAt(0).toString(16):encodeURIComponent(C).replace(/%/g,"").toLowerCase()}).join("")}function G(K){return K.length==0?"":decodeURIComponent("%"+(K.match(/.{1,2}/g)||[]).join("%"))}let L=function(K){return K=K.replace(new RegExp(Z(Q),"g")," "),`{${N(K.slice(1,K.length-1))}}`},W=function(K){if(K.startsWith("{")&&K.endsWith("}"))return G(K.slice(1,K.length-1))},H=z.replace(V,"").replace(new RegExp(`({[^}]*})+?|;([^${Z(Q)}]*)`,"g"),function(K,C,B){return C!==void 0?L(C):" "+L(`{${B.slice(1)}}`)}).replace(new RegExp(Z(Q),"g")," "),P=/(\([^()]+\))+?/g;while(P.test(H))H=H.replace(P,"");H=H.replace(/\d+\.(\.\.)?/g,""),H=H.replace(/\.\.\./g,""),H=H.replace(/\$\d+/g,"");let E=H.trim().split(new RegExp(/\s+/));E=E.filter((K)=>K!=="");let M="";for(let K=0;K<E.length;K++){let C=W(E[K]);if(C!==void 0){this._comments[this.fen()]=C;continue}let B=this._moveFromSan(E[K],J);if(B==null)if(Qz.indexOf(E[K])>-1)M=E[K];else throw new Error(`Invalid move in PGN: ${E[K]}`);else M="",this._makeMove(B),this._incPositionCount(this.fen())}if(M&&Object.keys(this._header).length&&this._header.Result!==M)this.setHeader("Result",M)}_moveToSan(z,J){let Q="";if(z.flags&Y.KSIDE_CASTLE)Q="O-O";else if(z.flags&Y.QSIDE_CASTLE)Q="O-O-O";else{if(z.piece!=="p"){let Z=Zz(z,J);Q+=z.piece.toUpperCase()+Z}if(z.flags&(Y.CAPTURE|Y.EP_CAPTURE)){if(z.piece==="p")Q+=A(z.from)[0];Q+="x"}if(Q+=A(z.to),z.promotion)Q+="="+z.promotion.toUpperCase()}if(this._makeMove(z),this.isCheck())if(this.isCheckmate())Q+="#";else Q+="+";return this._undoMove(),Q}_moveFromSan(z,J=!1){let Q=h(z),Z=c(Q),X=this._moves({legal:!0,piece:Z});for(let G=0,L=X.length;G<L;G++)if(Q===h(this._moveToSan(X[G],X)))return X[G];if(J)return null;let U=void 0,$=void 0,V=void 0,j=void 0,_=void 0,N=!1;if($=Q.match(/([pnbrqkPNBRQK])?([a-h][1-8])x?-?([a-h][1-8])([qrbnQRBN])?/),$){if(U=$[1],V=$[2],j=$[3],_=$[4],V.length==1)N=!0}else if($=Q.match(/([pnbrqkPNBRQK])?([a-h]?[1-8]?)x?-?([a-h][1-8])([qrbnQRBN])?/),$){if(U=$[1],V=$[2],j=$[3],_=$[4],V.length==1)N=!0}if(Z=c(Q),X=this._moves({legal:!0,piece:U?U:Z}),!j)return null;for(let G=0,L=X.length;G<L;G++)if(!V){if(Q===h(this._moveToSan(X[G],X)).replace("x",""))return X[G]}else if((!U||U.toLowerCase()==X[G].piece)&&D[V]==X[G].from&&D[j]==X[G].to&&(!_||_.toLowerCase()==X[G].promotion))return X[G];else if(N){let W=A(X[G].from);if((!U||U.toLowerCase()==X[G].piece)&&D[j]==X[G].to&&(V==W[0]||V==W[1])&&(!_||_.toLowerCase()==X[G].promotion))return X[G]}return null}ascii(){let z=`   +------------------------+
`;for(let J=D.a8;J<=D.h1;J++){if(q(J)===0)z+=" "+"87654321"[b(J)]+" |";if(this._board[J]){let Q=this._board[J].type,X=this._board[J].color==="w"?Q.toUpperCase():Q.toLowerCase();z+=" "+X+" "}else z+=" . ";if(J+1&136)z+=`|
`,J+=8}return z+=`   +------------------------+
`,z+="     a  b  c  d  e  f  g  h",z}perft(z){let J=this._moves({legal:!1}),Q=0,Z=this._turn;for(let X=0,U=J.length;X<U;X++){if(this._makeMove(J[X]),!this._isKingAttacked(Z))if(z-1>0)Q+=this.perft(z-1);else Q++;this._undoMove()}return Q}turn(){return this._turn}board(){let z=[],J=[];for(let Q=D.a8;Q<=D.h1;Q++){if(this._board[Q]==null)J.push(null);else J.push({square:A(Q),type:this._board[Q].type,color:this._board[Q].color});if(Q+1&136)z.push(J),J=[],Q+=8}return z}squareColor(z){if(z in D){let J=D[z];return(b(J)+q(J))%2===0?"light":"dark"}return null}history({verbose:z=!1}={}){let J=[],Q=[];while(this._history.length>0)J.push(this._undoMove());while(!0){let Z=J.pop();if(!Z)break;if(z)Q.push(new O(this,Z));else Q.push(this._moveToSan(Z,this._moves()));this._makeMove(Z)}return Q}_getPositionCount(z){let J=S(z);return this._positionCount[J]||0}_incPositionCount(z){let J=S(z);if(this._positionCount[J]===void 0)this._positionCount[J]=0;this._positionCount[J]+=1}_decPositionCount(z){let J=S(z);if(this._positionCount[J]===1)delete this._positionCount[J];else this._positionCount[J]-=1}_pruneComments(){let z=[],J={},Q=(Z)=>{if(Z in this._comments)J[Z]=this._comments[Z]};while(this._history.length>0)z.push(this._undoMove());Q(this.fen());while(!0){let Z=z.pop();if(!Z)break;this._makeMove(Z),Q(this.fen())}this._comments=J}getComment(){return this._comments[this.fen()]}setComment(z){this._comments[this.fen()]=z.replace("{","[").replace("}","]")}deleteComment(){return this.removeComment()}removeComment(){let z=this._comments[this.fen()];return delete this._comments[this.fen()],z}getComments(){return this._pruneComments(),Object.keys(this._comments).map((z)=>{return{fen:z,comment:this._comments[z]}})}deleteComments(){return this.removeComments()}removeComments(){return this._pruneComments(),Object.keys(this._comments).map((z)=>{let J=this._comments[z];return delete this._comments[z],{fen:z,comment:J}})}setCastlingRights(z,J){for(let Z of["k","q"])if(J[Z]!==void 0)if(J[Z])this._castling[z]|=x[Z];else this._castling[z]&=~x[Z];this._updateCastlingRights();let Q=this.getCastlingRights(z);return(J.k===void 0||J.k===Q.k)&&(J.q===void 0||J.q===Q.q)}getCastlingRights(z){return{["k"]:(this._castling[z]&x.k)!==0,["q"]:(this._castling[z]&x.q)!==0}}moveNumber(){return this._moveNumber}}export{Xz as validateFen,Uz as WHITE,Hz as SQUARES,d as SEVEN_TAG_ROSTER,Yz as ROOK,jz as QUEEN,Gz as PAWN,O as Move,Lz as KNIGHT,Kz as KING,_z as DEFAULT_POSITION,$z as Chess,Vz as BLACK,Dz as BISHOP};
